---
# Tests for db.on
# Check if the patches trigger the listeners

- comment: Listener with invalid function
  doc: {}
  invalidFn: true
  listeners:
  - "/foo"

- comment: Listener with function args different than 1
  doc: {}
  noArgsFn: true
  listeners:
  - "/foo"

- comment: Should trigger a listener
  doc: {}
  patch:
  - op: add
    path: "/foo/bar"
    value: 123
  listeners:
  - "/"
  - "/foo"
  - "/foo/bar"

- comment: Should trigger multiple listeners name the same
  doc: {}
  patch:
  - op: add
    path: "/foo/bar"
    value: 123
  listeners:
  - "/foo/bar"
  - "/foo/bar"

- comment: Should trigger a listener when multiple static values change underneath that node
  doc: {
    foo: {
      qux: 123
    }
  }
  patch:
  - op: add
    path: "/foo/bar/baz"
    value: 123
  - op: add
    path: "/foo/bam/boo"
    value: 321
  - op: add
    path: "/foo/bla/blo"
    value: 444
  dynamic:
    /foo/bar/boo: ['/foo/bam/boo']
  async: true
  listeners:
  - "/foo/bar"
  - "/foo"
  - "/foo"
  - "/bam"

- comment: One dynamic node with single path
  doc:
    bar: 123
  patch:
  - op: add
    path: /bar
    value: 321
  dynamic:
    /foo: ['/bar']
  listeners:
  - "/foo"

- comment: One dynamic node with two paths
  doc:
    bar: 123,
    baz: 321
  patch:
  - op: add
    path: /bar
    value: 321
  dynamic:
    /foo: ['/bar', '/baz']
  listeners:
  - "/foo"

- comment: One dynamic node with two paths
  doc:
    bar: 123,
    baz: 123,
    bam: 123
  patch:
  - op: add
    path: /bar
    value: 321
  dynamic:
    /foo: ['/bar', '/baz', '/bam']
  listeners:
  - "/foo"

- comment: Two dynamic nodes with single path
  doc:
    bar: 123,
  patch:
  - op: add
    path: /bar
    value: 321
  dynamic:
    /foo: ['/bar']
    /baz: ['/foo']
  listeners:
  - "/baz"

- comment: Two dynamic nodes with two paths
  doc:
    bar: 123,
  patch:
  - op: add
    path: /bar
    value: 321
  - op: add
    path: /boo
    value: 321
  - op: add
    path: /qux
    value: 321
  dynamic:
    /foo: ['/bar', '/boo']
    /baz: ['/foo', '/qux']
  listeners:
  - "/baz"

- comment: Three dynamic nodes with three paths
  doc:
    bar1: 123,
  patch:
  - op: add
    path: /bar1
    value: 321
  - op: add
    path: /bar2
    value: 321
  - op: add
    path: /bar3
    value: 321
  - op: add
    path: /foo2
    value: 321
  - op: add
    path: /foo3
    value: 321
  - op: add
    path: /baz2
    value: 321
  - op: add
    path: /baz3
    value: 321
  dynamic:
    /foo: ['/bar1', '/bar2', '/bar3']
    /baz: ['/foo', '/foo2', '/foo3']
    /bam: ['/baz', '/baz2', '/baz3']
  listeners:
  - "/bam"

- comment: Deep listener
  doc:
    foo:
      bar:
        baz: 123
  patch:
  - op: add
    path: /foo/bar/baz
    value: 321
  listeners:
  - /foo/bar/baz

- comment: Listener with error
  doc:
    foo: 123
  patch:
  - op: add
    path: /foo
    value: 321
  errFn: true
  listeners:
  - /foo

- comment: Multiple patch calls do not trigger
  doc:
    foo: 123
  patch:
  - op: add
    path: /foo
    value: 321
  - op: add
    path: /foo
    value: 321321
  - op: add
    path: /foo
    value: 321321
  async: true
  listeners:
  - /foo

- comment: Should trigger if is listening to a path changed by a merge
  doc:
    foo:
      bar: {}
  patch:
  - op: merge
    path: /foo/bar
    value:
      bam: 123
  dynamic:
    /bam: ['/foo/bar/bam']
  listeners:
  - /bam

- comment: Should trigger a nested dynanamic node
  doc:
    foo:
      bar:
        baz: aaa
  patch:
  - op: add
    path: /foo/bar/baz
    value: bbb
  dynamic:
    /qux: ['/foo']
  listeners:
  - /qux/bar

- comment: Should trigger if the listener is on a sub dynamic property
  doc:
    foo:
      bar: 123
  dynamic:
    /bam: ['/foo']
  patch:
  - op: add
    path: /foo/bar
    value: 124
  listeners:
  - /bam/bar
  async: true

- comment: Should unsubscribe a listener
  doc:
    foo: 123
  patch:
  - op: add
    path: /foo
    value: 124
  - op: add
    path: /foo
    value: 125
  listeners:
  - /foo
  async: true
  unsubscribe: true
